---
- name: Common variables
  hosts: all
  become: yes
  vars:
    cloud_app_dir: /opt/cloud-app
    local_files_path: ../files

- name: Init TerraCloud VMs
  hosts: all
  become: yes
  roles:
    - setup_ssh_key
    - install_docker
#    - setup_iptables

- name: Deploy app files
  hosts: all
  become: true

  vars:
    cloud_app_dir: /opt/cloud-app
    local_files_path: ../files

  tasks:
    - name: Create app directory
      ansible.builtin.file:
        path: "{{ cloud_app_dir }}"
        state: directory
        mode: '0755'

    - name: Template app .env file
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/.env.j2"
        dest: "{{ cloud_app_dir }}/.env"

    - name: Template app docker-compose file
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../files/docker-compose.yaml"
        dest: "{{ cloud_app_dir }}/docker-compose.yaml"

- name: Login ACR et lancer docker compose
  hosts: all
  become: yes

  tasks:
    - name: Login Ã  l'ACR
      ansible.builtin.command: >
        docker login tcdevacrfrc01.azurecr.io
        -u tcdevacrfrc01
        -p {{ acr_password }}

      args:
        chdir: /opt/cloud-app

    - name: Lancer docker compose up
      ansible.builtin.command: sudo docker compose up -d
      args:
        chdir: /opt/cloud-app
