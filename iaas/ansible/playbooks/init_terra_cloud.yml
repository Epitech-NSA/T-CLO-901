- name: Init TerraCloud VMs
  hosts: all
  become: yes
  roles:
    - setup_ssh_key
    - install_docker
#    - setup_iptables

- name: Deploy app files
  hosts: all
  become: true

  vars:
    cloud_app_dir: /opt/cloud-app
    local_files_path: ../files
    files_to_copy:
      - .env
      - docker-compose.yaml
  tasks:
    - name: Create folder {{ cloud_app_dir }}
      file:
        path: "{{ cloud_app_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Copy files {{ cloud_app_dir }}
      copy:
        src: "{{ local_files_path }}/{{ item }}"
        dest: "{{ cloud_app_dir }}/{{ item }}"
        owner: root
        group: root
        mode: '0644'
      loop: "{{ files_to_copy }}"

- name: Login ACR et lancer docker compose
  hosts: all
  become: yes

  vars:
    acr_password: "ACR_PASSWORD"

  tasks:
    - name: Aller dans le dossier /opt/cloud-app
      ansible.builtin.file:
        path: /opt/cloud-app
        state: directory

    - name: Login Ã  l'ACR
      ansible.builtin.command: >
        docker login tcdevacrfrc01.azurecr.io
        -u tcdevacrfrc01
        -p {{ acr_password }}

      args:
        chdir: /opt/cloud-app

    - name: Lancer docker compose up
      ansible.builtin.command: docker compose up -d
      args:
        chdir: /opt/cloud-app
